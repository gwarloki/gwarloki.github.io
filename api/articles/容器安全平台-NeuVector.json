{"title":"容器安全平台-NeuVector","uid":"56dbee3ed1ebfa2e56e8dd9905790f13","slug":"容器安全平台-NeuVector","date":"2022-03-04T09:47:49.000Z","updated":"2022-10-27T02:15:32.168Z","comments":true,"path":"api/articles/容器安全平台-NeuVector.json","keywords":null,"cover":"https://gtwallpaper.org/sites/default/files/wallpaper/159445/a-tunnel-8k-secret-passage-wallpapers-159445-3997-159990.png","content":"<h1 id=\"开源云原生产品现状\"><a href=\"#开源云原生产品现状\" class=\"headerlink\" title=\"开源云原生产品现状\"></a>开源云原生产品现状</h1><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>厂商</th>\n<th>链接</th>\n<th>Star</th>\n<th>类型</th>\n<th>开源时间</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>clair</td>\n<td>Quay</td>\n<td><a href=\"https://github.com/quay/clair\">https://github.com/quay/clair</a></td>\n<td>8.4k</td>\n<td>镜像扫描</td>\n<td>2015-11-13</td>\n</tr>\n<tr>\n<td>trivy</td>\n<td>Aqua</td>\n<td><a href=\"https://github.com/aquasecurity/trivy\">https://github.com/aquasecurity/trivy</a></td>\n<td>10.1k</td>\n<td>镜像扫描</td>\n<td>2019-04-11</td>\n</tr>\n<tr>\n<td>kube-hunter</td>\n<td>Aqua</td>\n<td><a href=\"https://github.com/aquasecurity/kube-hunter/\">https://github.com/aquasecurity/kube-hunter/</a></td>\n<td>3.4k</td>\n<td>漏洞扫描</td>\n<td>2018-07-18</td>\n</tr>\n<tr>\n<td>kube-bench</td>\n<td>Aqua</td>\n<td><a href=\"https://github.com/aquasecurity/kube-bench\">https://github.com/aquasecurity/kube-bench</a></td>\n<td>4.5k</td>\n<td>CIS 安全基线</td>\n<td>2017-06-19</td>\n</tr>\n<tr>\n<td>starboard</td>\n<td>Aqua</td>\n<td><a href=\"https://github.com/aquasecurity/starboard\">https://github.com/aquasecurity/starboard</a></td>\n<td>968</td>\n<td>Dashboard</td>\n<td>2020-03-17</td>\n</tr>\n<tr>\n<td>tracee</td>\n<td>Aqua</td>\n<td><a href=\"https://github.com/aquasecurity/tracee\">https://github.com/aquasecurity/tracee</a></td>\n<td>1.5k</td>\n<td>基于 eBPF 的系统事件追踪</td>\n<td>2019-09-18</td>\n</tr>\n<tr>\n<td>anchore-engine</td>\n<td>anchore</td>\n<td><a href=\"https://github.com/anchore/anchore-engine\">https://github.com/anchore/anchore-engine</a></td>\n<td>1.4k</td>\n<td>漏洞扫描</td>\n<td>2017-09-06</td>\n</tr>\n<tr>\n<td>kyverno</td>\n<td>kyverno.io</td>\n<td><a href=\"https://github.com/kyverno/kyverno\">https://github.com/kyverno/kyverno</a></td>\n<td>1.8k</td>\n<td>Kubernetes 策略与审计</td>\n<td>2019-02-04</td>\n</tr>\n<tr>\n<td>GateKeeper</td>\n<td>OPA (sysdig)</td>\n<td><a href=\"https://github.com/open-policy-agent/gatekeeper\">https://github.com/open-policy-agent/gatekeeper</a></td>\n<td>1.3k</td>\n<td>Kubernetes 策略与审计</td>\n<td>2018-10-26</td>\n</tr>\n<tr>\n<td>falco</td>\n<td>falcosecurity(sysdig)</td>\n<td><a href=\"https://github.com/falcosecurity/falco\">https://github.com/falcosecurity/falco</a></td>\n<td>4.4k</td>\n<td>基于内核模块的系统事件追踪、警告</td>\n<td>2016-01-19</td>\n</tr>\n<tr>\n<td>terrascan</td>\n<td>accurics.com</td>\n<td><a href=\"https://github.com/accurics/terrascan\">https://github.com/accurics/terrascan</a></td>\n<td>2.7k</td>\n<td>通用的 IaS 配置扫描</td>\n<td>2017-09-11</td>\n</tr>\n<tr>\n<td>Kubei</td>\n<td>portshift</td>\n<td><a href=\"https://github.com/cisco-open/kubei\">https://github.com/cisco-open/kubei</a></td>\n<td>489</td>\n<td>镜像扫描(带面板)</td>\n<td>2020-03-22</td>\n</tr>\n<tr>\n<td>Polaris</td>\n<td>Fairwinds</td>\n<td><a href=\"https://github.com/FairwindsOps/polaris\">https://github.com/FairwindsOps/polaris</a></td>\n<td>2.4k</td>\n<td>配置扫描与策略</td>\n<td>2018-11-15</td>\n</tr>\n<tr>\n<td>kubesec</td>\n<td>controlplaneio</td>\n<td><a href=\"https://github.com/controlplaneio/kubesec\">https://github.com/controlplaneio/kubesec</a></td>\n<td>667</td>\n<td>Kubernetes 配置扫描</td>\n<td>2017-10-10</td>\n</tr>\n<tr>\n<td>KubeEye</td>\n<td>KubeSphere</td>\n<td><a href=\"https://github.com/kubesphere/kubeeye\">https://github.com/kubesphere/kubeeye</a></td>\n<td>424</td>\n<td>基于策略的 Kubernetes 集群配置扫描</td>\n<td>2020-11-07</td>\n</tr>\n<tr>\n<td>kube-linter</td>\n<td>Stackrox(RedHat)</td>\n<td><a href=\"https://github.com/stackrox/kube-linter\">https://github.com/stackrox/kube-linter</a></td>\n<td>1.8k</td>\n<td>Kubernetes 配置扫描</td>\n<td>2020-08-13</td>\n</tr>\n</tbody></table>\n<h1 id=\"NeuVector架构\"><a href=\"#NeuVector架构\" class=\"headerlink\" title=\"NeuVector架构\"></a>NeuVector架构</h1><p><img src=\"https://s2.loli.net/2022/03/04/sAmWTN4waKuGjEh.png\"></p>\n<ul>\n<li>Manager, NeuVector 的 Web 控制台，为用户提供了统一的管理 UI，便于用户查看安全事件、管理安全解决方案、规则等。</li>\n<li>Controller, Backend 服务器及控制器，管理如 Enforcer、Scanner 等其他组件，分发安全策略及调度扫描任务。</li>\n<li>Scanner, 用户执行漏洞扫描、基线扫描等任务。</li>\n<li>Enforcer, 一个轻量级的容器，用于拦截系统事件，执行安全策略等。通常以 Daemon set 运行再集群中的每个节点上。</li>\n<li>Updater， 用于更新 CVE 数据库。</li>\n</ul>\n<h1 id=\"主要功能\"><a href=\"#主要功能\" class=\"headerlink\" title=\"主要功能\"></a>主要功能</h1><ul>\n<li><p>安全漏洞扫描</p>\n</li>\n<li><p>容器网络流量可视化</p>\n</li>\n<li><p>网络安全策略定义</p>\n</li>\n<li><p>L7 防火墙</p>\n</li>\n<li><p>CICD 安全扫描</p>\n</li>\n<li><p>合规分析</p>\n</li>\n</ul>\n<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><h3 id=\"使用-helm-安装-NeuVector\"><a href=\"#使用-helm-安装-NeuVector\" class=\"headerlink\" title=\"使用 helm 安装 NeuVector\"></a>使用 helm 安装 NeuVector</h3><ul>\n<li>创建 namespace</li>\n</ul>\n<p><code>kubectl create namespace neuvector</code> </p>\n<ul>\n<li>创建 serviceaccount</li>\n</ul>\n<p><code>kubectl create serviceaccount neuvector -n neuvector</code> </p>\n<ul>\n<li>添加 neuvector 的 helm 仓库</li>\n</ul>\n<p><code>helm repo add neuvector https://neuvector.github.io/neuvector-helm/</code> </p>\n<ul>\n<li>安装 neuvector</li>\n</ul>\n<p><code>helm install my-neuvector --namespace neuvector neuvector/core</code> </p>\n<p><img src=\"https://pek3b.qingstor.com/kubesphere-community/images/202202151736913.png\"></p>\n<ul>\n<li><p>替换镜像</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>由于 neuvector 镜像需要权限才能获取，这里将镜像替换为 preview 版本 更多安装信息请参考：<a href=\"https://github.com/neuvector/neuvector-helm/tree/master/charts/core\">https://github.com/neuvector/neuvector-helm/tree/master/charts/core</a></p></blockquote>\n</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">kubectl set image deployment.apps&#x2F;neuvector-controller-pod *&#x3D;neuvector&#x2F;controller.preview:5.0.0-preview.1 -n neuvector\nkubectl set image deployment.apps&#x2F;neuvector-manager-pod *&#x3D;neuvector&#x2F;manager.preview:5.0.0-preview.1 -n neuvector\nkubectl set image deployment.apps&#x2F;neuvector-scanner-pod *&#x3D;neuvector&#x2F;scanner.preview:latest -n neuvector\nkubectl set image daemonset.apps&#x2F;neuvector-enforcer-pod *&#x3D;neuvector&#x2F;enforcer.preview:5.0.0-preview.1 -n neuvector\nkubectl get cronjob&#x2F;neuvector-updater-pod -n neuvector -o yaml | sed &#39;s#image: registry.neuvector.com&#x2F;updater:latest#image: neuvector&#x2F;updater.preview:latest#&#39; | kubectl replace -f -&#96; </code></pre>\n\n<p><a href=\"https://github.com/neuvector/neuvector-helm/tree/master/charts/core\">Helm-chart 参数查看</a></p>\n<h2 id=\"quick-start\"><a href=\"#quick-start\" class=\"headerlink\" title=\"quick start\"></a>quick start</h2><ol>\n<li>创建 namespace<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl create namespace neuvector</code></pre></li>\n<li>部署 CRD( Kubernetes 1.19+ 版本)<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;neuvector&#x2F;manifests&#x2F;main&#x2F;kubernetes&#x2F;crd-k8s-1.19.yaml</code></pre></li>\n<li>部署 CRD(Kubernetes 1.18或更低版本)<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;neuvector&#x2F;manifests&#x2F;main&#x2F;kubernetes&#x2F;crd-k8s-1.16.yaml</code></pre></li>\n<li>配置 RBAC<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">kubectl create clusterrole neuvector-binding-app --verb&#x3D;get,list,watch,update --resource&#x3D;nodes,pods,services,namespaces\nkubectl create clusterrole neuvector-binding-rbac --verb&#x3D;get,list,watch --resource&#x3D;rolebindings.rbac.authorization.k8s.io,roles.rbac.authorization.k8s.io,clusterrolebindings.rbac.authorization.k8s.io,clusterroles.rbac.authorization.k8s.io\nkubectl create clusterrolebinding neuvector-binding-app --clusterrole&#x3D;neuvector-binding-app --serviceaccount&#x3D;neuvector:default\nkubectl create clusterrolebinding neuvector-binding-rbac --clusterrole&#x3D;neuvector-binding-rbac --serviceaccount&#x3D;neuvector:default\nkubectl create clusterrole neuvector-binding-admission --verb&#x3D;get,list,watch,create,update,delete --resource&#x3D;validatingwebhookconfigurations,mutatingwebhookconfigurations\nkubectl create clusterrolebinding neuvector-binding-admission --clusterrole&#x3D;neuvector-binding-admission --serviceaccount&#x3D;neuvector:default\nkubectl create clusterrole neuvector-binding-customresourcedefinition --verb&#x3D;watch,create,get --resource&#x3D;customresourcedefinitions\nkubectl create clusterrolebinding  neuvector-binding-customresourcedefinition --clusterrole&#x3D;neuvector-binding-customresourcedefinition --serviceaccount&#x3D;neuvector:default\nkubectl create clusterrole neuvector-binding-nvsecurityrules --verb&#x3D;list,delete --resource&#x3D;nvsecurityrules,nvclustersecurityrules\nkubectl create clusterrolebinding neuvector-binding-nvsecurityrules --clusterrole&#x3D;neuvector-binding-nvsecurityrules --serviceaccount&#x3D;neuvector:default\nkubectl create clusterrolebinding neuvector-binding-view --clusterrole&#x3D;view --serviceaccount&#x3D;neuvector:default\nkubectl create rolebinding neuvector-admin --clusterrole&#x3D;admin --serviceaccount&#x3D;neuvector:default -n neuvector</code></pre></li>\n<li>检查是否有以下 RBAC 对象<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">kubectl get clusterrolebinding  | grep neuvector\nkubectl get rolebinding -n neuvector | grep neuvector\n\nkubectl get clusterrolebinding  | grep neuvector\n\nneuvector-binding-admission                            ClusterRole&#x2F;neuvector-binding-admission                            44h\nneuvector-binding-app                                  ClusterRole&#x2F;neuvector-binding-app                                  44h\nneuvector-binding-customresourcedefinition             ClusterRole&#x2F;neuvector-binding-customresourcedefinition             44h\nneuvector-binding-nvadmissioncontrolsecurityrules      ClusterRole&#x2F;neuvector-binding-nvadmissioncontrolsecurityrules      44h\nneuvector-binding-nvsecurityrules                      ClusterRole&#x2F;neuvector-binding-nvsecurityrules                      44h\nneuvector-binding-nvwafsecurityrules                   ClusterRole&#x2F;neuvector-binding-nvwafsecurityrules                   44h\nneuvector-binding-rbac                                 ClusterRole&#x2F;neuvector-binding-rbac                                 44h\nneuvector-binding-view                                 ClusterRole&#x2F;view                                                   44h\n\nkubectl get rolebinding -n neuvector | grep neuvector\nneuvector-admin         ClusterRole&#x2F;admin            44h\nneuvector-binding-psp   Role&#x2F;neuvector-binding-psp   44h</code></pre></li>\n<li>部署 NeuVector<br>底层 Runtime 为 Docker<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;neuvector&#x2F;manifests&#x2F;main&#x2F;kubernetes&#x2F;5.0.0&#x2F;neuvector-docker-k8s.yaml</code></pre>\n底层 Runtime 为 Containerd（对于 k3s 和 rke2 可以使用此 yaml 文件）<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;neuvector&#x2F;manifests&#x2F;main&#x2F;kubernetes&#x2F;5.0.0&#x2F;neuvector-containerd-k8s.yaml</code></pre></li>\n</ol>\n<p>1.21 以下的 Kubernetes 版本会提示以下错误，将 yaml 文件下载将 batch&#x2F;v1 修改为 batch&#x2F;v1beta1</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">error: unable to recognize &quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;neuvector&#x2F;manifests&#x2F;main&#x2F;kubernetes&#x2F;5.0.0&#x2F;neuvector-docker-k8s.yaml&quot;: no matches for kind &quot;CronJob&quot; in version &quot;batch&#x2F;v1&quot;</code></pre>\n<p>1.20.x cronjob 还处于 beta 阶段，1.21 版本开始 cronjob 才正式 GA 。</p>\n<p>默认部署web-ui使用的是loadblance类型的Service，为了方便访问修改为NodePort，也可以通过 Ingress 对外提供服务</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">kubectl patch svc neuvector-service-webui -n neuvector --type&#x3D;&#39;json&#39; -p &#39;[&#123;&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;&#x2F;spec&#x2F;type&quot;,&quot;value&quot;:&quot;NodePort&quot;&#125;,&#123;&quot;op&quot;:&quot;add&quot;,&quot;path&quot;:&quot;&#x2F;spec&#x2F;ports&#x2F;0&#x2F;nodePort&quot;,&quot;value&quot;:30888&#125;]&#39;</code></pre>\n<h2 id=\"高可用架构设计\"><a href=\"#高可用架构设计\" class=\"headerlink\" title=\"高可用架构设计\"></a>高可用架构设计</h2><p><img src=\"https://s2.loli.net/2022/03/29/GXsaPfwo2nFAp7S.png\"><br>NeuVector-HA 主要需要考虑 Controller 模块的 HA，只要有一个 Controller 处于打开状态，所有数据都将在 3 个副本之间之间同步。</p>\n<p>Controller 数据主要存储在 &#x2F;var&#x2F;neuvector&#x2F; 目录中，但出现 POD 重建或集群重新部署时，会自动从此目录加载备份文件，进行集群恢复。</p>\n<h3 id=\"部署策略\"><a href=\"#部署策略\" class=\"headerlink\" title=\"部署策略\"></a>部署策略</h3><p>NeuVector 官方提供四种 HA 部署模式<br><img src=\"https://s2.loli.net/2022/03/29/sn48dDVmegoByqX.png\"></p>\n<ul>\n<li>方式一：不进行任何调度限制，由 Kubernetes 进行自由调度管理管理。</li>\n<li>方式二：NeuVector control 组件 (manager,controller）+enforce、scanner组件配置调度 label 限制和污点容忍，与 Kubernetes master 节点部署一起。</li>\n<li>方式三：给 Kubernetes 集群中通过 Taint 方式建立专属的 NeuVector 节点，只允许 Neuvector control 组件部署。</li>\n<li>方式四：NeuVector control 组件 (manager,controller）配置调度 label 限制和污点容忍，与 Kubernetes master 节点部署一起。k8s-master 不部署 enforce 和 scanner 组件，意味着 master 节点不在接受扫描和策略下发。</li>\n</ul>\n<h3 id=\"方式二部署样例\"><a href=\"#方式二部署样例\" class=\"headerlink\" title=\"方式二部署样例\"></a>方式二部署样例</h3><ol>\n<li>给 master 节点打上特定标签<br><code>kubectl label nodes nodename nvcontroller=true</code></li>\n<li>获取节点 Taint<br><code>kubectl get node nodename -o yaml|grep -A 5 taint</code></li>\n<li>以 Rancher 部署的节点 master 节点为例<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io&#x2F;controlplane\n    value: &quot;true&quot;\n  - effect: NoExecute\n    key: node-role.kubernetes.io&#x2F;etcd</code></pre></li>\n<li>编辑部署的 yaml 给 NeuVector-control 组件（manager,controller）添加 nodeSelector 和 tolerations 给 enforce、scanner 组件只添加 tolerations 。<br>例如编辑manager组件：<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">kind: Deployment\nmetadata:\n  name: neuvector-manager-pod\n  namespace: neuvector\nspec:\n  selector:\n    matchLabels:\n      app: neuvector-manager-pod\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: neuvector-manager-pod\n    spec:\n      nodeSelector:\n        nvcontroller: &quot;true&quot;\n      containers:\n        - name: neuvector-manager-pod\n          image: neuvector&#x2F;manager.preview:5.0.0-preview.1\n          env:\n            - name: CTRL_SERVER_IP\n              value: neuvector-svc-controller.neuvector\n      restartPolicy: Always\n      tolerations:\n      - effect: NoSchedule\n        key: &quot;node-role.kubernetes.io&#x2F;controlplane&quot;\n        operator: Equal\n        value: &quot;true&quot;\n      - effect: NoExecute\n        operator: &quot;Equal&quot;\n        key: &quot;node-role.kubernetes.io&#x2F;etcd&quot;\n        value: &quot;true&quot;</code></pre></li>\n</ol>\n<h3 id=\"数据持久化方案\"><a href=\"#数据持久化方案\" class=\"headerlink\" title=\"数据持久化方案\"></a>数据持久化方案</h3><ol>\n<li>配置环境变量启用配置数据持久化<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">- env:\n  - name: CTRL_PERSIST_CONFIG</code></pre>\n配置此环境变量后，默认情况下 NeuVector-Controller 会将数据存储在 &#x2F;var&#x2F;neuvector 目录内，默认此目录是 hostpath 映射在 POD 所在宿主机的 &#x2F;var&#x2F;neuvector 目录内。</li>\n</ol>\n<p>若需要更高级别数据可靠性也可以通过 PV 对接 nfs 或其他支出多读写的存储中。</p>\n<p>这样当出现 NeuVector-Controller 三个 POD 副本同时都销毁，宿主机都完全不可恢复时，也不会有数据配置数据丢失。<br>以下以 NFS 为例，部署NFS创建PV和PVC。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">cat &lt;&lt;EOF | kubectl apply -f -\n\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: neuvector-data\nspec:\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteMany \n  nfs:\n    path: &#x2F;nfsdata\n    server: 172.16.0.195 \n\nEOF\ncat &lt;&lt;EOF | kubectl apply -f -\n\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: neuvector-data\n  namespace: neuvector\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 10Gi\nEOF</code></pre>\n<p>修改 NeuVector-Controller 部署 yaml，添加 pvc 信息，将 &#x2F;var&#x2F;neuvector 目录映射到 nfs 中（默认是hostpath映射到本地)</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">spec:\n  template:\n    spec:\n      volumes:\n        - name: nv-share\n#         hostPath:                        &#x2F;&#x2F; replaced by persistentVolumeClaim\n#           path: &#x2F;var&#x2F;neuvector        &#x2F;&#x2F; replaced by persistentVolumeClaim\n          persistentVolumeClaim:\n            claimName: neuvector-data</code></pre>\n<p>或直接在 NeuVector 部署 yaml 中挂载 nfs 目录</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">volumes:\n      - name: nv-share\n        nfs:\n          path: &#x2F;opt&#x2F;nfs-deployment\n          server: 172.26.204.144</code></pre>\n<h2 id=\"多云安全管理\"><a href=\"#多云安全管理\" class=\"headerlink\" title=\"多云安全管理\"></a>多云安全管理</h2><p><img src=\"https://s2.loli.net/2022/03/29/Y7Eqp4XSbmh1g2Q.png\"><br>在实际生产应用中，会存在对多个集群进行安全进行管理，NeuVector 支持集群联邦功能。</p>\n<p>需要在一个集群上暴露 Federation Master 服务，在每个远端集群上部署 Federation Worker 服务。为了更好的灵活性，可以在每个集群同时启用 Federation Master 和 Federation Worker 服务。</p>\n<p>在每个集群部署此 yaml</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-service-controller-fed-master\n  namespace: neuvector\nspec:\n  ports:\n  - port: 11443\n    name: fed\n    nodePort: 30627\n    protocol: TCP\n  type: NodePort\n  selector:\n    app: neuvector-controller-pod\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-service-controller-fed-worker\n  namespace: neuvector\nspec:\n  ports:\n  - port: 10443\n    name: fed\n    nodePort: 31783\n    protocol: TCP\n  type: NodePort\n  selector:\n    app: neuvector-controller-pod</code></pre>\n\n<p><img src=\"https://s2.loli.net/2022/04/22/wAxazhFlWBYPDdS.png\"></p>\n<p><img src=\"https://s2.loli.net/2022/04/22/omzdRGKpY8w6EnO.png\"></p>\n<p><a href=\"https://mp.weixin.qq.com/s/7MKVFhViqRIm7h8Pq3XmOQ\">云原生安全平台 NeuVector 部署</a><br><a href=\"https://mp.weixin.qq.com/s/aXSA_opN-rV68rnrPO73PA\">快速上手云原生安全平台 NeuVector</a><br><a href=\"https://mp.weixin.qq.com/s?__biz=MzIyMTUwMDMyOQ==&mid=2247498632&idx=1&sn=c8ce1947433681a7a7bb6621187bac57&scene=21#wechat_redirect\">实用教程 | 云原生安全平台 NeuVector 部署</a><br><a href=\"https://kubesphere.com.cn/blogs/neuvector-cloud-native-security/\">云原生安全产品 NeuVector 简介</a></p>\n","text":"开源云原生产品现状 项目 厂商 链接 Star 类型 开源时间 clair Quay https://github.com/quay/clair 8.4k 镜像扫描 2015-11-13 trivy Aqua https://github.com/aquasecurity/tri...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"Cloud-Native-Security","slug":"Cloud-Native-Security","count":12,"path":"api/categories/Cloud-Native-Security.json"}],"tags":[{"name":"云原生安全","slug":"云原生安全","count":6,"path":"api/tags/云原生安全.json"},{"name":"NeuVector","slug":"NeuVector","count":1,"path":"api/tags/NeuVector.json"},{"name":"容器安全平台","slug":"容器安全平台","count":5,"path":"api/tags/容器安全平台.json"},{"name":"suse","slug":"suse","count":1,"path":"api/tags/suse.json"},{"name":"产品选型","slug":"产品选型","count":6,"path":"api/tags/产品选型.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BC%80%E6%BA%90%E4%BA%91%E5%8E%9F%E7%94%9F%E4%BA%A7%E5%93%81%E7%8E%B0%E7%8A%B6\"><span class=\"toc-text\">开源云原生产品现状</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#NeuVector%E6%9E%B6%E6%9E%84\"><span class=\"toc-text\">NeuVector架构</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD\"><span class=\"toc-text\">主要功能</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">安装</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8-helm-%E5%AE%89%E8%A3%85-NeuVector\"><span class=\"toc-text\">使用 helm 安装 NeuVector</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#quick-start\"><span class=\"toc-text\">quick start</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">高可用架构设计</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5\"><span class=\"toc-text\">部署策略</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%96%B9%E5%BC%8F%E4%BA%8C%E9%83%A8%E7%BD%B2%E6%A0%B7%E4%BE%8B\"><span class=\"toc-text\">方式二部署样例</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">数据持久化方案</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%A4%9A%E4%BA%91%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86\"><span class=\"toc-text\">多云安全管理</span></a></li></ol></li></ol>","author":{"name":"Moses","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"开源漏洞库工具-OpenCVE","uid":"c1f27b84e7a962a64fb70a195391b7ba","slug":"搭建漏洞库-OpenCVE","date":"2022-04-08T07:56:44.000Z","updated":"2022-10-26T07:53:48.607Z","comments":true,"path":"api/articles/搭建漏洞库-OpenCVE.json","keywords":null,"cover":"https://images.unsplash.com/photo-1571361656693-d7602246ce3c?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=628&ixid=MnwxfDB8MXxhbGx8fHx8fHx8fHwxNjE5ODc0NTE5&ixlib=rb-1.2.1&q=80&utm_campaign=api-credit&utm_medium=referral&utm_source=unsplash_source&w=1200","text":"简介OpenCVE是一个平台，用于本地导入CVE列表并对其进行搜索（按供应商、产品、CVSS、CWE…）。 项目地址OpenCVE 文档OpenCVE Documentation 原理 数据源 CPE: https://nvd.nist.gov/feeds/xml/cpe/dic...","link":"","photos":[],"count_time":{"symbolsCount":"5.3k","symbolsTime":"5 mins."},"categories":[{"name":"软件供应链安全","slug":"软件供应链安全","count":26,"path":"api/categories/软件供应链安全.json"}],"tags":[{"name":"开源漏洞库","slug":"开源漏洞库","count":2,"path":"api/tags/开源漏洞库.json"},{"name":"部署手册","slug":"部署手册","count":3,"path":"api/tags/部署手册.json"},{"name":"OpenCVE","slug":"OpenCVE","count":1,"path":"api/tags/OpenCVE.json"}],"author":{"name":"Moses","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"容器安全平台-小佑科技","uid":"af03dd5b5c07726870f53848ba50413b","slug":"容器安全平台-小佑科技","date":"2022-03-04T09:35:44.000Z","updated":"2022-10-27T02:15:54.248Z","comments":true,"path":"api/articles/容器安全平台-小佑科技.json","keywords":null,"cover":"https://gtwallpaper.org/sites/default/files/wallpaper/159413/4k-aurora-wallpapers-159413-3333-6138359.png","text":"install 修改k8s-dosec-web.yaml和k8s-dosec-configMap.yamlenv: - name:Web_API_ADDR value: &#39;http:&#x2F;&#x2F;masterip:30089&#39; #configmap #注...","link":"","photos":[],"count_time":{"symbolsCount":571,"symbolsTime":"1 mins."},"categories":[{"name":"Cloud-Native-Security","slug":"Cloud-Native-Security","count":12,"path":"api/categories/Cloud-Native-Security.json"}],"tags":[{"name":"云原生安全","slug":"云原生安全","count":6,"path":"api/tags/云原生安全.json"},{"name":"容器安全平台","slug":"容器安全平台","count":5,"path":"api/tags/容器安全平台.json"},{"name":"产品选型","slug":"产品选型","count":6,"path":"api/tags/产品选型.json"},{"name":"小佑科技","slug":"小佑科技","count":1,"path":"api/tags/小佑科技.json"}],"author":{"name":"Moses","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}